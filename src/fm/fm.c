#include "../audio.h"
#include "../fir_filter.h"
#include "fm.h"

#include <stdio.h>
#include <stdlib.h>

#define PI 3.14159265359F

#define N_FIR_FILT_250kFS_15kPA_19kST 191
static const float FIR_FILT_250kFS_15kPA_19kST[N_FIR_FILT_250kFS_15kPA_19kST] = { 0.000044219730495340614F, 0.00009440017413002246F, 0.00018365481566381955F, 0.000314099657926496F, 0.0004888737347517136F, 0.0007052772638324323F, 0.0009530618154668994F, 0.001213501937310202F, 0.0014596543220620815F, 0.0016580911975254515F, 0.001772185264006052F, 0.0017667596615661733F, 0.0016136092510598552F, 0.001297190984372922F, 0.0008195541472049096F, 0.00020354235282485188F, -0.0005066031610256816F, -0.0012477912293477878F, -0.001943943396882769F, -0.00251478878088645F, -0.0028866415213852177F, -0.0030037479174223553F, -0.0028384913862145285F, -0.0023986640082025623F, -0.0017302297502465027F, -0.0009145766054104768F, -0.00006000902620814281F, 0.0007118808025280118F, 0.001283360665884154F, 0.0015588594476816553F, 0.001481605191451303F, 0.0010457625891767785F, 0.000301574090541716F, -0.0006479550570090435F, -0.0016591971640395236F, -0.0025677034644882584F, -0.0032131562544198277F, -0.003465828593184935F, -0.0032503729137945982F, -0.002562689289902561F, -0.0014764994872995415F, -0.00013761807392919704F, 0.0012542869500616768F, 0.0024743875585363107F, 0.0033080964852317337F, 0.0035876984968087194F, 0.0032243131182875307F, 0.0022293060231395614F, 0.0007207561105883507F, -0.0010874563644707642F, -0.0029135440066924215F, -0.004449451207866056F, -0.005410406821700571F, -0.005584735973844371F, -0.004875586071167914F, -0.0033268844512126033F, -0.0011278522188292914F, 0.0014064950686490984F, 0.00387759706914003F, 0.005863192233064355F, 0.0069862331966464705F, 0.006982135774058983F, 0.005753020181664978F, 0.00339881578041101F, 0.00021810770475836572F, -0.0033240087439066236F, -0.006658563768166884F, -0.009198145015204788F, -0.010433066286096221F, -0.010023483549336699F, -0.00787209465450969F, -0.004163924710020362F, 0.0006360702272000808F, 0.005831057067516668F, 0.010582242431390191F, 0.014030521700937876F, 0.01543312771302555F, 0.01429615792087495F, 0.010481576834571455F, 0.0042709935291500465F, -0.003627267347436748F, -0.012133396981147423F, -0.019910142427153145F, -0.025523793696773867F, -0.027632445479650606F, -0.025176691782452826F, -0.017546427721962674F, -0.004699384557322631F, 0.012787565557979339F, 0.033744553187915624F, 0.056512266250085125F, 0.07911237948405572F, 0.09946490871347209F, 0.11562550933926899F, 0.12601248946447888F, 0.1295942215312001F, 0.12601248946447888F, 0.11562550933926899F, 0.09946490871347209F, 0.07911237948405572F, 0.056512266250085125F, 0.033744553187915624F, 0.012787565557979339F, -0.004699384557322631F, -0.017546427721962674F, -0.025176691782452826F, -0.027632445479650606F, -0.025523793696773867F, -0.019910142427153145F, -0.012133396981147423F, -0.003627267347436748F, 0.0042709935291500465F, 0.010481576834571455F, 0.01429615792087495F, 0.01543312771302555F, 0.014030521700937876F, 0.010582242431390191F, 0.005831057067516668F, 0.0006360702272000808F, -0.004163924710020362F, -0.00787209465450969F, -0.010023483549336699F, -0.010433066286096221F, -0.009198145015204788F, -0.006658563768166884F, -0.0033240087439066236F, 0.00021810770475836572F, 0.00339881578041101F, 0.005753020181664978F, 0.006982135774058983F, 0.0069862331966464705F, 0.005863192233064355F, 0.00387759706914003F, 0.0014064950686490984F, -0.0011278522188292914F, -0.0033268844512126033F, -0.004875586071167914F, -0.005584735973844371F, -0.005410406821700571F, -0.004449451207866056F, -0.0029135440066924215F, -0.0010874563644707642F, 0.0007207561105883507F, 0.0022293060231395614F, 0.0032243131182875307F, 0.0035876984968087194F, 0.0033080964852317337F, 0.0024743875585363107F, 0.0012542869500616768F, -0.00013761807392919704F, -0.0014764994872995415F, -0.002562689289902561F, -0.0032503729137945982F, -0.003465828593184935F, -0.0032131562544198277F, -0.0025677034644882584F, -0.0016591971640395236F, -0.0006479550570090435F, 0.000301574090541716F, 0.0010457625891767785F, 0.001481605191451303F, 0.0015588594476816553F, 0.001283360665884154F, 0.0007118808025280118F, -0.00006000902620814281F, -0.0009145766054104768F, -0.0017302297502465027F, -0.0023986640082025623F, -0.0028384913862145285F, -0.0030037479174223553F, -0.0028866415213852177F, -0.00251478878088645F, -0.001943943396882769F, -0.0012477912293477878F, -0.0005066031610256816F, 0.00020354235282485188F, 0.0008195541472049096F, 0.001297190984372922F, 0.0016136092510598552F, 0.0017667596615661733F, 0.001772185264006052F, 0.0016580911975254515F, 0.0014596543220620815F, 0.001213501937310202F, 0.0009530618154668994F, 0.0007052772638324323F, 0.0004888737347517136F, 0.000314099657926496F, 0.00018365481566381955F, 0.00009440017413002246F, 0.000044219730495340614F };

void polar_discriminant(const float complex* const input, size_t input_len, float** output, size_t* output_len)
{
    *output_len = input_len;
    float* output_buffer = (float*)malloc(*output_len * sizeof(float));
    *output = output_buffer;

    float complex prev_sample = 0.0F + 0.0F*I;
    for(size_t i = 0; i < input_len; ++i) {
        output_buffer[i] = cargf(input[i] * conjf(prev_sample)) / PI;
        prev_sample = input[i];
    }
}

void demodulate_fm(const iq_data_t* const iq_data)
{
    audio_data_t audio_data;
    audio_data.sample_rate_Hz = iq_data->sample_rate_Hz;

    polar_discriminant(iq_data->samples, iq_data->num_samples, &audio_data.samples, &audio_data.num_samples);

    fir_filter_r_t audio_filter;
    init_filter_r(&audio_filter, FIR_FILT_250kFS_15kPA_19kST, N_FIR_FILT_250kFS_15kPA_19kST);

    uint32_t decimation_factor = 4;
    audio_data_t filtered_audio_data;
    filtered_audio_data.sample_rate_Hz = audio_data.sample_rate_Hz / decimation_factor;

    apply_filter_r(&audio_filter, decimation_factor, audio_data.samples, audio_data.num_samples, &filtered_audio_data.samples, &filtered_audio_data.num_samples);
    destroy_filter_r(&audio_filter);

    destroy_audio_data(&audio_data);

    const char* audio_out_filename = "audio.bin";
    FILE* fp = fopen(audio_out_filename, "wb");
    if(!fp) {
        fprintf(stderr, "Failed to open file: \"%s\"\n", audio_out_filename);
    } else {
        fwrite(filtered_audio_data.samples, 1, filtered_audio_data.num_samples * sizeof(float), fp);
        fclose(fp);
    }

    destroy_audio_data(&filtered_audio_data);
}
