#include "../real.h"
#include "../fir_filter.h"
#include "../plot.h"
#include "fm.h"

#include <float.h>
#include <math.h>
#include <stdbool.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#define PI 3.14159265359F

static const float FIR_FILT_250kFS_15kPA_19kST[] = { 0.000044219730495340614F, 0.00009440017413002246F, 0.00018365481566381955F, 0.000314099657926496F, 0.0004888737347517136F, 0.0007052772638324323F, 0.0009530618154668994F, 0.001213501937310202F, 0.0014596543220620815F, 0.0016580911975254515F, 0.001772185264006052F, 0.0017667596615661733F, 0.0016136092510598552F, 0.001297190984372922F, 0.0008195541472049096F, 0.00020354235282485188F, -0.0005066031610256816F, -0.0012477912293477878F, -0.001943943396882769F, -0.00251478878088645F, -0.0028866415213852177F, -0.0030037479174223553F, -0.0028384913862145285F, -0.0023986640082025623F, -0.0017302297502465027F, -0.0009145766054104768F, -0.00006000902620814281F, 0.0007118808025280118F, 0.001283360665884154F, 0.0015588594476816553F, 0.001481605191451303F, 0.0010457625891767785F, 0.000301574090541716F, -0.0006479550570090435F, -0.0016591971640395236F, -0.0025677034644882584F, -0.0032131562544198277F, -0.003465828593184935F, -0.0032503729137945982F, -0.002562689289902561F, -0.0014764994872995415F, -0.00013761807392919704F, 0.0012542869500616768F, 0.0024743875585363107F, 0.0033080964852317337F, 0.0035876984968087194F, 0.0032243131182875307F, 0.0022293060231395614F, 0.0007207561105883507F, -0.0010874563644707642F, -0.0029135440066924215F, -0.004449451207866056F, -0.005410406821700571F, -0.005584735973844371F, -0.004875586071167914F, -0.0033268844512126033F, -0.0011278522188292914F, 0.0014064950686490984F, 0.00387759706914003F, 0.005863192233064355F, 0.0069862331966464705F, 0.006982135774058983F, 0.005753020181664978F, 0.00339881578041101F, 0.00021810770475836572F, -0.0033240087439066236F, -0.006658563768166884F, -0.009198145015204788F, -0.010433066286096221F, -0.010023483549336699F, -0.00787209465450969F, -0.004163924710020362F, 0.0006360702272000808F, 0.005831057067516668F, 0.010582242431390191F, 0.014030521700937876F, 0.01543312771302555F, 0.01429615792087495F, 0.010481576834571455F, 0.0042709935291500465F, -0.003627267347436748F, -0.012133396981147423F, -0.019910142427153145F, -0.025523793696773867F, -0.027632445479650606F, -0.025176691782452826F, -0.017546427721962674F, -0.004699384557322631F, 0.012787565557979339F, 0.033744553187915624F, 0.056512266250085125F, 0.07911237948405572F, 0.09946490871347209F, 0.11562550933926899F, 0.12601248946447888F, 0.1295942215312001F, 0.12601248946447888F, 0.11562550933926899F, 0.09946490871347209F, 0.07911237948405572F, 0.056512266250085125F, 0.033744553187915624F, 0.012787565557979339F, -0.004699384557322631F, -0.017546427721962674F, -0.025176691782452826F, -0.027632445479650606F, -0.025523793696773867F, -0.019910142427153145F, -0.012133396981147423F, -0.003627267347436748F, 0.0042709935291500465F, 0.010481576834571455F, 0.01429615792087495F, 0.01543312771302555F, 0.014030521700937876F, 0.010582242431390191F, 0.005831057067516668F, 0.0006360702272000808F, -0.004163924710020362F, -0.00787209465450969F, -0.010023483549336699F, -0.010433066286096221F, -0.009198145015204788F, -0.006658563768166884F, -0.0033240087439066236F, 0.00021810770475836572F, 0.00339881578041101F, 0.005753020181664978F, 0.006982135774058983F, 0.0069862331966464705F, 0.005863192233064355F, 0.00387759706914003F, 0.0014064950686490984F, -0.0011278522188292914F, -0.0033268844512126033F, -0.004875586071167914F, -0.005584735973844371F, -0.005410406821700571F, -0.004449451207866056F, -0.0029135440066924215F, -0.0010874563644707642F, 0.0007207561105883507F, 0.0022293060231395614F, 0.0032243131182875307F, 0.0035876984968087194F, 0.0033080964852317337F, 0.0024743875585363107F, 0.0012542869500616768F, -0.00013761807392919704F, -0.0014764994872995415F, -0.002562689289902561F, -0.0032503729137945982F, -0.003465828593184935F, -0.0032131562544198277F, -0.0025677034644882584F, -0.0016591971640395236F, -0.0006479550570090435F, 0.000301574090541716F, 0.0010457625891767785F, 0.001481605191451303F, 0.0015588594476816553F, 0.001283360665884154F, 0.0007118808025280118F, -0.00006000902620814281F, -0.0009145766054104768F, -0.0017302297502465027F, -0.0023986640082025623F, -0.0028384913862145285F, -0.0030037479174223553F, -0.0028866415213852177F, -0.00251478878088645F, -0.001943943396882769F, -0.0012477912293477878F, -0.0005066031610256816F, 0.00020354235282485188F, 0.0008195541472049096F, 0.001297190984372922F, 0.0016136092510598552F, 0.0017667596615661733F, 0.001772185264006052F, 0.0016580911975254515F, 0.0014596543220620815F, 0.001213501937310202F, 0.0009530618154668994F, 0.0007052772638324323F, 0.0004888737347517136F, 0.000314099657926496F, 0.00018365481566381955F, 0.00009440017413002246F, 0.000044219730495340614F };
static const float FIR_FILT_250kFS_100kPA_105kST[] = { 0.006070605487454018F, 0.01443402125039274F, 0.003957176954417116F, -0.006535244989599065F, 0.0031187571195364274F, 0.0008788288645458518F, -0.003152063493691762F, 0.0033074824188423385F, -0.0019563566347321594F, -0.0000025383003585240167F, 0.0016799331349582338F, -0.002575570344332358F, 0.00241397113454167F, -0.001397456697452616F, -0.00011472040180456252F, 0.0015983789247068835F, -0.002512407806746633F, 0.0025711208951452666F, -0.0017085805309174612F, 0.0001728688337901377F, 0.001522693696331991F, -0.0027756503415741125F, 0.003139961991236923F, -0.0023877168791097054F, 0.0006911070754891852F, 0.0013954938375801867F, -0.0031639324578624805F, 0.003946348838187892F, -0.003370945227201318F, 0.0015043655171701233F, 0.0010929587055851092F, -0.003540088206073499F, 0.004936743470639754F, -0.004686088584383647F, 0.0027040886187351806F, 0.0004727755075597306F, -0.0037923630167455685F, 0.006069663758519273F, -0.00637512086870205F, 0.004401003996342946F, -0.0006286072117454427F, -0.0037692431030611163F, 0.007271847207576821F, -0.008509681144083387F, 0.006790694495379134F, -0.0024281973430471883F, -0.0032954149989525695F, 0.008471502086090477F, -0.011181525650613497F, 0.01015676206577768F, -0.005315208528685315F, -0.00205813889816767F, 0.009619887176772717F, -0.01466953669794694F, 0.015051233680384236F, -0.00998261729272495F, 0.0005146939348710277F, 0.01060827917417486F, -0.019635329327555812F, 0.02294867703898887F, -0.01832826815369223F, 0.00592488168896409F, 0.011383598799338635F, -0.028448255024472447F, 0.03904460237343456F, -0.03753170300608063F, 0.02052489922392698F, 0.011868484728511467F, -0.055678532884019305F, 0.10370293145139495F, -0.1470442752839363F, 0.1771743251172417F, 0.8120392115232855F, 0.1771743251172417F, -0.1470442752839363F, 0.10370293145139495F, -0.055678532884019305F, 0.011868484728511467F, 0.02052489922392698F, -0.03753170300608063F, 0.03904460237343456F, -0.028448255024472447F, 0.011383598799338635F, 0.00592488168896409F, -0.01832826815369223F, 0.02294867703898887F, -0.019635329327555812F, 0.01060827917417486F, 0.0005146939348710277F, -0.00998261729272495F, 0.015051233680384236F, -0.01466953669794694F, 0.009619887176772717F, -0.00205813889816767F, -0.005315208528685315F, 0.01015676206577768F, -0.011181525650613497F, 0.008471502086090477F, -0.0032954149989525695F, -0.0024281973430471883F, 0.006790694495379134F, -0.008509681144083387F, 0.007271847207576821F, -0.0037692431030611163F, -0.0006286072117454427F, 0.004401003996342946F, -0.00637512086870205F, 0.006069663758519273F, -0.0037923630167455685F, 0.0004727755075597306F, 0.0027040886187351806F, -0.004686088584383647F, 0.004936743470639754F, -0.003540088206073499F, 0.0010929587055851092F, 0.0015043655171701233F, -0.003370945227201318F, 0.003946348838187892F, -0.0031639324578624805F, 0.0013954938375801867F, 0.0006911070754891852F, -0.0023877168791097054F, 0.003139961991236923F, -0.0027756503415741125F, 0.001522693696331991F, 0.0001728688337901377F, -0.0017085805309174612F, 0.0025711208951452666F, -0.002512407806746633F, 0.0015983789247068835F, -0.00011472040180456252F, -0.001397456697452616F, 0.00241397113454167F, -0.002575570344332358F, 0.0016799331349582338F, -0.0000025383003585240167F, -0.0019563566347321594F, 0.0033074824188423385F, -0.003152063493691762F, 0.0008788288645458518F, 0.0031187571195364274F, -0.006535244989599065F, 0.003957176954417116F, 0.01443402125039274F, 0.006070605487454018F };
static const float FIR_FILT_250kFS_15kST_19kPA_23kST[] = { 0.00002186049509107674F, 0.00002148396213941167F, 0.00001682144439570617F, 0.00001686769773950027F, 0.0000010191389401586149F, -0.000011450970021997338F, -0.00003335839016432808F, -0.00004519067251052767F, -0.0000546325661676918F, -0.00004556712879457773F, -0.00002697183992353956F, 0.000008500825864916095F, 0.000045978169727299516F, 0.00008377299553377199F, 0.000104397289920598F, 0.00010528782508211015F, 0.00007646968026200298F, 0.00002524878622019595F, -0.00004364248513214421F, -0.00011104973254897488F, -0.00016312923195234853F, -0.00018082859941203215F, -0.00015779752598597666F, -0.00009169463055263385F, 0.000003796584994252645F, 0.00011039037586467313F, 0.000200769053411812F, 0.0002526256272763464F, 0.00024800414870480576F, 0.00018467745238268034F, 0.00007244686573520938F, -0.00006343967395525025F, -0.00019228311540143468F, -0.0002815348074897488F, -0.0003088016303251629F, -0.0002649115858202949F, -0.00015976965419551873F, -0.000017729183609026582F, 0.00012614430365716096F, 0.00023735904307052282F, 0.0002893937562649823F, 0.00027260016923164986F, 0.000195236258814746F, 0.00008218553197954107F, -0.00003378420604580497F, -0.00012094442862705953F, -0.00015929857494847074F, -0.0001458706970839293F, -0.0000961360959238518F, -0.00003778584982842385F, -0.0000013133374913793716F, -0.000007720030684394465F, -0.00005982121267799738F, -0.00013818368935546285F, -0.00020588022027894314F, -0.00021947205197875254F, -0.00014520355175636382F, 0.000026110815387183268F, 0.00026928774776650003F, 0.0005255420619919887F, 0.0007142823642535377F, 0.0007549400011413993F, 0.0005927932040877653F, 0.00022202249793693417F, -0.0003022847794018742F, -0.0008680639196702439F, -0.0013282632899865457F, -0.0015365492311874731F, -0.0013891287562363874F, -0.0008608605307317877F, -0.000025022839517765305F, 0.0009515140942105542F, 0.0018395748170936016F, 0.002400211475254855F, 0.0024467972387850873F, 0.0019008662547621816F, 0.0008257400594637503F, -0.0005733615026859549F, -0.001986694648549552F, -0.0030684500982304805F, -0.003521402390015131F, -0.0031770426879557546F, -0.0020495836742489846F, -0.00034769623785701364F, 0.0015624378876281197F, 0.0032371307077044124F, 0.00426041059880422F, 0.004349130453010546F, 0.0034310814559108567F, 0.0016743038316092568F, -0.0005425566442639179F, -0.0027141532490525147F, -0.004327727715208816F, -0.004988923697386273F, -0.0045221401560338785F, -0.003018963722382617F, -0.0008207897501091808F, 0.0015615419450415767F, 0.003571954738393172F, 0.004745970857780717F, 0.004825129871954215F, 0.0038191499917012463F, 0.0019995427103806436F, -0.00017380827486420463F, -0.002173484154524518F, -0.00354064064579608F, -0.003999742659672664F, -0.0035213780041675594F, -0.002316699404452391F, -0.000766358278894568F, 0.0006950232541426331F, 0.0017049654796022823F, 0.002073149898688304F, 0.0018260789347778294F, 0.0011835456194709993F, 0.0004744166437466697F, 0.00001796580358037362F, 0.000008211720655441892F, 0.00043904013685011807F, 0.0010964580967462547F, 0.0016243897312467387F, 0.0016471982624432493F, 0.0009127527573310849F, -0.0005896387616884872F, -0.0025782962803346057F, -0.004519782519252244F, -0.005759550275968239F, -0.005712712689128534F, -0.004063364447981687F, -0.000912206694451004F, 0.003179009195176106F, 0.007273197304262038F, 0.010265588306757254F, 0.011168979974448465F, 0.009404944095056725F, 0.005019877740476917F, -0.0012430010094766403F, -0.008051808931464371F, -0.013764722402063393F, -0.016822217550219613F, -0.016159749147025722F, -0.011533639264429603F, -0.003666372193983712F, 0.005842898320401575F, 0.014839931723462754F, 0.021105550154556924F, 0.022902420136204315F, 0.019443539771208957F, 0.011158106852689859F, -0.0003264466185943463F, -0.012500541926956679F, -0.022526682395749727F, -0.027908080146685776F, -0.027112537626420474F, -0.019994857504326658F, -0.007903445505643657F, 0.006570457218667412F, 0.02015587065113263F, 0.029653507996352756F, 0.032700136085586806F, 0.028360778078923784F, 0.017399197267744575F, 0.0021508412334274155F, -0.013982989864708828F, -0.027308482332785558F, -0.034700958438315534F, -0.03435032779976753F, -0.02620956688459068F, -0.012033901845555726F, 0.005005003346539747F, 0.021043265853372396F, 0.03241893482780035F, 0.036525008075324716F, 0.03241893482780035F, 0.021043265853372396F, 0.005005003346539747F, -0.012033901845555726F, -0.02620956688459068F, -0.03435032779976753F, -0.034700958438315534F, -0.027308482332785558F, -0.013982989864708828F, 0.0021508412334274155F, 0.017399197267744575F, 0.028360778078923784F, 0.032700136085586806F, 0.029653507996352756F, 0.02015587065113263F, 0.006570457218667412F, -0.007903445505643657F, -0.019994857504326658F, -0.027112537626420474F, -0.027908080146685776F, -0.022526682395749727F, -0.012500541926956679F, -0.0003264466185943463F, 0.011158106852689859F, 0.019443539771208957F, 0.022902420136204315F, 0.021105550154556924F, 0.014839931723462754F, 0.005842898320401575F, -0.003666372193983712F, -0.011533639264429603F, -0.016159749147025722F, -0.016822217550219613F, -0.013764722402063393F, -0.008051808931464371F, -0.0012430010094766403F, 0.005019877740476917F, 0.009404944095056725F, 0.011168979974448465F, 0.010265588306757254F, 0.007273197304262038F, 0.003179009195176106F, -0.000912206694451004F, -0.004063364447981687F, -0.005712712689128534F, -0.005759550275968239F, -0.004519782519252244F, -0.0025782962803346057F, -0.0005896387616884872F, 0.0009127527573310849F, 0.0016471982624432493F, 0.0016243897312467387F, 0.0010964580967462547F, 0.00043904013685011807F, 0.000008211720655441892F, 0.00001796580358037362F, 0.0004744166437466697F, 0.0011835456194709993F, 0.0018260789347778294F, 0.002073149898688304F, 0.0017049654796022823F, 0.0006950232541426331F, -0.000766358278894568F, -0.002316699404452391F, -0.0035213780041675594F, -0.003999742659672664F, -0.00354064064579608F, -0.002173484154524518F, -0.00017380827486420463F, 0.0019995427103806436F, 0.0038191499917012463F, 0.004825129871954215F, 0.004745970857780717F, 0.003571954738393172F, 0.0015615419450415767F, -0.0008207897501091808F, -0.003018963722382617F, -0.0045221401560338785F, -0.004988923697386273F, -0.004327727715208816F, -0.0027141532490525147F, -0.0005425566442639179F, 0.0016743038316092568F, 0.0034310814559108567F, 0.004349130453010546F, 0.00426041059880422F, 0.0032371307077044124F, 0.0015624378876281197F, -0.00034769623785701364F, -0.0020495836742489846F, -0.0031770426879557546F, -0.003521402390015131F, -0.0030684500982304805F, -0.001986694648549552F, -0.0005733615026859549F, 0.0008257400594637503F, 0.0019008662547621816F, 0.0024467972387850873F, 0.002400211475254855F, 0.0018395748170936016F, 0.0009515140942105542F, -0.000025022839517765305F, -0.0008608605307317877F, -0.0013891287562363874F, -0.0015365492311874731F, -0.0013282632899865457F, -0.0008680639196702439F, -0.0003022847794018742F, 0.00022202249793693417F, 0.0005927932040877653F, 0.0007549400011413993F, 0.0007142823642535377F, 0.0005255420619919887F, 0.00026928774776650003F, 0.000026110815387183268F, -0.00014520355175636382F, -0.00021947205197875254F, -0.00020588022027894314F, -0.00013818368935546285F, -0.00005982121267799738F, -0.000007720030684394465F, -0.0000013133374913793716F, -0.00003778584982842385F, -0.0000961360959238518F, -0.0001458706970839293F, -0.00015929857494847074F, -0.00012094442862705953F, -0.00003378420604580497F, 0.00008218553197954107F, 0.000195236258814746F, 0.00027260016923164986F, 0.0002893937562649823F, 0.00023735904307052282F, 0.00012614430365716096F, -0.000017729183609026582F, -0.00015976965419551873F, -0.0002649115858202949F, -0.0003088016303251629F, -0.0002815348074897488F, -0.00019228311540143468F, -0.00006343967395525025F, 0.00007244686573520938F, 0.00018467745238268034F, 0.00024800414870480576F, 0.0002526256272763464F, 0.000200769053411812F, 0.00011039037586467313F, 0.000003796584994252645F, -0.00009169463055263385F, -0.00015779752598597666F, -0.00018082859941203215F, -0.00016312923195234853F, -0.00011104973254897488F, -0.00004364248513214421F, 0.00002524878622019595F, 0.00007646968026200298F, 0.00010528782508211015F, 0.000104397289920598F, 0.00008377299553377199F, 0.000045978169727299516F, 0.000008500825864916095F, -0.00002697183992353956F, -0.00004556712879457773F, -0.0000546325661676918F, -0.00004519067251052767F, -0.00003335839016432808F, -0.000011450970021997338F, 0.0000010191389401586149F, 0.00001686769773950027F, 0.00001682144439570617F, 0.00002148396213941167F, 0.00002186049509107674F };
static const float FIR_FILT_250kFS_34kST_38kPA_42kST[] = { 0.00001384444594115794F, -0.000004591169041496157F, -0.00001653496173522891F, -0.000021461918727091762F, -0.000008795798798491243F, 0.000016524895903144673F, 0.00003337805832779914F, 0.000021352887003817884F, -0.000017100753426308605F, -0.00005140920575070814F, -0.00004551904311605619F, 0.000006798847213849588F, 0.00006698467310074916F, 0.00007808567126593732F, 0.000016693925897861722F, -0.00007549064042907876F, -0.00011697617644339459F, -0.0000567975899703576F, 0.00006944992596865434F, 0.00015578458067592714F, 0.00011322946463813107F, -0.00004221861891016031F, -0.00018558694724444348F, -0.0001817698422151748F, -0.000010655196646455884F, 0.00019582838188007365F, 0.00025350545816777646F, 0.00008915378706077589F, -0.0001767226624124636F, -0.00031563672661680215F, -0.000187297671498048F, 0.00012205648244420789F, 0.00035350911953985334F, 0.00029273707686943134F, -0.00003197234343721017F, -0.0003538452368141513F, -0.00038795221281995816F, -0.00008505451501870302F, 0.00030869177875025096F, 0.0004533255837081464F, 0.0002119728998299978F, -0.00021908178443342304F, -0.0004716803495429109F, -0.00032510957928759475F, 0.00009743597883736905F, 0.0004335928127258627F, 0.0003985587370699262F, 0.000032430573691834834F, -0.0003421698013311462F, -0.0004104273901383841F, -0.00013828109799906107F, 0.0002159683206262113F, 0.0003499255055120833F, 0.00018560998905873445F, -0.00008861032150094451F, -0.00022351661575231575F, -0.00014607321047149392F, 0.000004465353926340917F, 0.00005844095708992863F, 0.000006789477716400125F, -0.000010305377607550934F, 0.00009811607453324418F, 0.00022172251303546179F, 0.00014407434353081106F, -0.00018506053434935992F, -0.0005012710761192474F, -0.00042281732145283844F, 0.00013847693418684445F, 0.0007673932828243603F, 0.0008325665928226402F, 0.00009376041759349113F, -0.0009373975785830394F, -0.0013230563767312904F, -0.0005365033066475644F, 0.0009247443597603281F, 0.0018097170975171644F, 0.0011744934690891178F, -0.0006577539274435154F, -0.0021840969804286757F, -0.0019458308593481197F, 0.00009916256184760637F, 0.002332092363755756F, 0.002744568417303211F, 0.0007377909802616713F, -0.002157414316687118F, -0.003433788781931379F, -0.0017812139163704101F, 0.001605984215531328F, 0.003868289131402283F, 0.0029037352059734156F, -0.0006858548440499322F, -0.003923577776406188F, -0.003938653760199456F, -0.000522593973163312F, 0.0035258231602416246F, 0.004707585925768477F, 0.0018705717789971224F, -0.0026764284371829303F, -0.005055859845677857F, -0.003160144393730752F, 0.0014644426776271445F, 0.004888986538632493F, 0.00417781621808822F, -0.00006231427015571608F, -0.004202523944415633F, -0.004737120866253847F, -0.0012971906914309803F, 0.003097479979355832F, 0.004722702554379066F, 0.002360992541816808F, -0.001775717388938174F, -0.0041265095234704575F, -0.002906697858825006F, 0.0005129543779889706F, 0.0030670202148661615F, 0.0027955260266155223F, 0.00038844855430106767F, -0.0017847747812889015F, -0.0020162345744700887F, -0.0006600641057241907F, 0.0006114476511300714F, 0.0007093787595288132F, 0.00013070255285918187F, 0.0000851352450170727F, 0.0008360906785534454F, 0.0012202432184872157F, 0.00002778497125082543F, -0.0022172110635211672F, -0.00323177069299006F, -0.001172607288539209F, 0.002979838687346633F, 0.005561983978098917F, 0.0033965751629384234F, -0.00270126716735066F, -0.007724726270688088F, -0.0065317355844982F, 0.0010789534500237703F, 0.009159640155550762F, 0.010190701882881894F, 0.0019911773742210736F, -0.009326238167286928F, -0.013803419394888161F, -0.006363102431660601F, 0.007806906784192733F, 0.016692755146384457F, 0.011628576785082103F, -0.004400461898534909F, -0.018179036021377847F, -0.01715102492985937F, -0.000812061091930195F, 0.017697250052935824F, 0.022143867571944066F, 0.0074441569328116235F, -0.014906782737058161F, -0.025783246532747675F, -0.014831185431011579F, 0.00977336864995915F, 0.02733796971981905F, 0.02210761491452084F, -0.002606519742181533F, -0.026295089071438488F, -0.028324343011013737F, -0.005957327905232919F, 0.02245896021005313F, 0.03258844478347919F, 0.015026486599676345F, -0.016005142967333755F, -0.034202680176755235F, -0.0235713094319424F, 0.007477549935700578F, 0.03278110133329015F, 0.030569447807395827F, 0.0022731277038490786F, -0.028320359354904182F, -0.035155770214511585F, -0.012201574431426032F, 0.021213342000043926F, 0.03675222966448402F, 0.021213342000043926F, -0.012201574431426032F, -0.035155770214511585F, -0.028320359354904182F, 0.0022731277038490786F, 0.030569447807395827F, 0.03278110133329015F, 0.007477549935700578F, -0.0235713094319424F, -0.034202680176755235F, -0.016005142967333755F, 0.015026486599676345F, 0.03258844478347919F, 0.02245896021005313F, -0.005957327905232919F, -0.028324343011013737F, -0.026295089071438488F, -0.002606519742181533F, 0.02210761491452084F, 0.02733796971981905F, 0.00977336864995915F, -0.014831185431011579F, -0.025783246532747675F, -0.014906782737058161F, 0.0074441569328116235F, 0.022143867571944066F, 0.017697250052935824F, -0.000812061091930195F, -0.01715102492985937F, -0.018179036021377847F, -0.004400461898534909F, 0.011628576785082103F, 0.016692755146384457F, 0.007806906784192733F, -0.006363102431660601F, -0.013803419394888161F, -0.009326238167286928F, 0.0019911773742210736F, 0.010190701882881894F, 0.009159640155550762F, 0.0010789534500237703F, -0.0065317355844982F, -0.007724726270688088F, -0.00270126716735066F, 0.0033965751629384234F, 0.005561983978098917F, 0.002979838687346633F, -0.001172607288539209F, -0.00323177069299006F, -0.0022172110635211672F, 0.00002778497125082543F, 0.0012202432184872157F, 0.0008360906785534454F, 0.0000851352450170727F, 0.00013070255285918187F, 0.0007093787595288132F, 0.0006114476511300714F, -0.0006600641057241907F, -0.0020162345744700887F, -0.0017847747812889015F, 0.00038844855430106767F, 0.0027955260266155223F, 0.0030670202148661615F, 0.0005129543779889706F, -0.002906697858825006F, -0.0041265095234704575F, -0.001775717388938174F, 0.002360992541816808F, 0.004722702554379066F, 0.003097479979355832F, -0.0012971906914309803F, -0.004737120866253847F, -0.004202523944415633F, -0.00006231427015571608F, 0.00417781621808822F, 0.004888986538632493F, 0.0014644426776271445F, -0.003160144393730752F, -0.005055859845677857F, -0.0026764284371829303F, 0.0018705717789971224F, 0.004707585925768477F, 0.0035258231602416246F, -0.000522593973163312F, -0.003938653760199456F, -0.003923577776406188F, -0.0006858548440499322F, 0.0029037352059734156F, 0.003868289131402283F, 0.001605984215531328F, -0.0017812139163704101F, -0.003433788781931379F, -0.002157414316687118F, 0.0007377909802616713F, 0.002744568417303211F, 0.002332092363755756F, 0.00009916256184760637F, -0.0019458308593481197F, -0.0021840969804286757F, -0.0006577539274435154F, 0.0011744934690891178F, 0.0018097170975171644F, 0.0009247443597603281F, -0.0005365033066475644F, -0.0013230563767312904F, -0.0009373975785830394F, 0.00009376041759349113F, 0.0008325665928226402F, 0.0007673932828243603F, 0.00013847693418684445F, -0.00042281732145283844F, -0.0005012710761192474F, -0.00018506053434935992F, 0.00014407434353081106F, 0.00022172251303546179F, 0.00009811607453324418F, -0.000010305377607550934F, 0.000006789477716400125F, 0.00005844095708992863F, 0.000004465353926340917F, -0.00014607321047149392F, -0.00022351661575231575F, -0.00008861032150094451F, 0.00018560998905873445F, 0.0003499255055120833F, 0.0002159683206262113F, -0.00013828109799906107F, -0.0004104273901383841F, -0.0003421698013311462F, 0.000032430573691834834F, 0.0003985587370699262F, 0.0004335928127258627F, 0.00009743597883736905F, -0.00032510957928759475F, -0.0004716803495429109F, -0.00021908178443342304F, 0.0002119728998299978F, 0.0004533255837081464F, 0.00030869177875025096F, -0.00008505451501870302F, -0.00038795221281995816F, -0.0003538452368141513F, -0.00003197234343721017F, 0.00029273707686943134F, 0.00035350911953985334F, 0.00012205648244420789F, -0.000187297671498048F, -0.00031563672661680215F, -0.0001767226624124636F, 0.00008915378706077589F, 0.00025350545816777646F, 0.00019582838188007365F, -0.000010655196646455884F, -0.0001817698422151748F, -0.00018558694724444348F, -0.00004221861891016031F, 0.00011322946463813107F, 0.00015578458067592714F, 0.00006944992596865434F, -0.0000567975899703576F, -0.00011697617644339459F, -0.00007549064042907876F, 0.000016693925897861722F, 0.00007808567126593732F, 0.00006698467310074916F, 0.000006798847213849588F, -0.00004551904311605619F, -0.00005140920575070814F, -0.000017100753426308605F, 0.000021352887003817884F, 0.00003337805832779914F, 0.000016524895903144673F, -0.000008795798798491243F, -0.000021461918727091762F, -0.00001653496173522891F, -0.000004591169041496157F, 0.00001384444594115794F };
static const float FIR_FILT_250KFS_19KST_38KPA_57KST[] = { -0.000059190286210820066F, -0.00013776764885021112F, -0.00007152644808706401F, 0.0003782954906276137F, 0.0009199312914170475F, 0.0006735187616906354F, -0.0008506749745959796F, -0.0025909354123260296F, -0.0023650128766912145F, 0.0006741725577564498F, 0.004190925336005032F, 0.004455993851525405F, 0.0005801068868625814F, -0.0038745060163531365F, -0.00459171378608173F, -0.0014678935386222224F, 0.0014865622197133075F, 0.0013917940547188141F, -0.0000513814017074292F, 0.0004221945035298959F, 0.0025525622507564087F, 0.0028543323956039786F, -0.000047948869921730126F, -0.0030098021767039802F, -0.0027176239243419916F, -0.00043653063092828273F, 0.00009343367651999811F, -0.0014660791431981954F, -0.0015099158812028816F, 0.001618858013677035F, 0.004422601656815907F, 0.0031429538590094096F, -0.00047094488972297726F, -0.0016632969102191337F, 0.00006415094988382673F, 0.0002986404309927816F, -0.0029171298643793277F, -0.005242337655485315F, -0.0023844726557244434F, 0.0028409521062208744F, 0.004190423367788751F, 0.0013237751855134955F, 0.00014956622638961334F, 0.003117610291886328F, 0.004724515494403303F, 0.00009414712654895387F, -0.006409559054271181F, -0.006799198084872778F, -0.001474384767427709F, 0.0013118188417231965F, -0.0015192156029662446F, -0.002790312563408813F, 0.00315627287690735F, 0.010010469877853813F, 0.007950195301434983F, -0.0010442106915128423F, -0.0054296859144424905F, -0.0016345731788308794F, 0.0005283529887762169F, -0.0058143495261392805F, -0.01195654994550379F, -0.006131154756053422F, 0.0070798118714713405F, 0.011855419738394659F, 0.004730132156773939F, -0.00019147706804855126F, 0.005840235858903735F, 0.01086593567565924F, 0.0006835200387245293F, -0.01633402437177049F, -0.01888795794262375F, -0.004793072481493861F, 0.004835100640727523F, -0.0014999038719455942F, -0.006619083285207832F, 0.007627471957747575F, 0.027412379571753607F, 0.02372418189900987F, -0.0025328955600959673F, -0.018333649166387342F, -0.008008904481635782F, 0.0013115552254014129F, -0.0166689074203808F, -0.039151223407278744F, -0.022799324226020695F, 0.025927509510933217F, 0.04979225995414384F, 0.023595253251104904F, -0.0019625216121879185F, 0.023670886333211353F, 0.05756646783327814F, 0.007110749868191838F, -0.1233102655300246F, -0.19156422827517172F, -0.07703603997327517F, 0.14568604261861376F, 0.25940664545056313F, 0.14568604261861376F, -0.07703603997327517F, -0.19156422827517172F, -0.1233102655300246F, 0.007110749868191838F, 0.05756646783327814F, 0.023670886333211353F, -0.0019625216121879185F, 0.023595253251104904F, 0.04979225995414384F, 0.025927509510933217F, -0.022799324226020695F, -0.039151223407278744F, -0.0166689074203808F, 0.0013115552254014129F, -0.008008904481635782F, -0.018333649166387342F, -0.0025328955600959673F, 0.02372418189900987F, 0.027412379571753607F, 0.007627471957747575F, -0.006619083285207832F, -0.0014999038719455942F, 0.004835100640727523F, -0.004793072481493861F, -0.01888795794262375F, -0.01633402437177049F, 0.0006835200387245293F, 0.01086593567565924F, 0.005840235858903735F, -0.00019147706804855126F, 0.004730132156773939F, 0.011855419738394659F, 0.0070798118714713405F, -0.006131154756053422F, -0.01195654994550379F, -0.0058143495261392805F, 0.0005283529887762169F, -0.0016345731788308794F, -0.0054296859144424905F, -0.0010442106915128423F, 0.007950195301434983F, 0.010010469877853813F, 0.00315627287690735F, -0.002790312563408813F, -0.0015192156029662446F, 0.0013118188417231965F, -0.001474384767427709F, -0.006799198084872778F, -0.006409559054271181F, 0.00009414712654895387F, 0.004724515494403303F, 0.003117610291886328F, 0.00014956622638961334F, 0.0013237751855134955F, 0.004190423367788751F, 0.0028409521062208744F, -0.0023844726557244434F, -0.005242337655485315F, -0.0029171298643793277F, 0.0002986404309927816F, 0.00006415094988382673F, -0.0016632969102191337F, -0.00047094488972297726F, 0.0031429538590094096F, 0.004422601656815907F, 0.001618858013677035F, -0.0015099158812028816F, -0.0014660791431981954F, 0.00009343367651999811F, -0.00043653063092828273F, -0.0027176239243419916F, -0.0030098021767039802F, -0.000047948869921730126F, 0.0028543323956039786F, 0.0025525622507564087F, 0.0004221945035298959F, -0.0000513814017074292F, 0.0013917940547188141F, 0.0014865622197133075F, -0.0014678935386222224F, -0.00459171378608173F, -0.0038745060163531365F, 0.0005801068868625814F, 0.004455993851525405F, 0.004190925336005032F, 0.0006741725577564498F, -0.0023650128766912145F, -0.0025909354123260296F, -0.0008506749745959796F, 0.0006735187616906354F, 0.0009199312914170475F, 0.0003782954906276137F, -0.00007152644808706401F, -0.00013776764885021112F, -0.000059190286210820066F };

void convert_data_ftos(const float* const input, int16_t* const output, size_t len)
{
    for(size_t i = 0; i < len; ++i) {
        output[i] = input[i] * INT16_MAX;
    }
}

bool write_data_to_file(const void* const data, size_t size, const char* const filename)
{
    FILE* fp = fopen(filename, "wb");

    if(!fp) {
        fprintf(stderr, "Failed to open file: \"%s\"\n", filename);
        return false;
    }

    fwrite(data, 1, size, fp);
    fclose(fp);

    return true;
}

void normalise(float* const data, size_t len)
{
    float abs_max = FLT_MIN;
    for(size_t i = 0; i < len; ++i) {
        abs_max = fmax(fabs(data[i]), abs_max);
    }
    for(size_t i = 0; i < len; ++i) {
        data[i] /= abs_max;
    }
}

void deemphasis_filtering(const float* const input, size_t input_len, float** const output, size_t* output_len)
{
    //           w_ca         1                 1 - (-1) z^-1
    //    H(z) = ---- * ----------- * --------------------------------
    //           2 fs        -w_ca                   -w_ca
    //                   1 - -----               1 + -----
    //                        2 fs                    2 fs
    //                                     1 - -------------- z^-1
    //                                               -w_ca
    //                                           1 - -----
    //                                                2 fs
    //            Y(z)
    //    H(z) = ------
    //            X(z)
    //
    //    Y(z) = k_3 + k_3 * z^-1
    //    X(x) = k_4 + k_5 * z^-1
    //    (k_4 + k_5 * z^-1)Y(z) = (k_3 + k_3 * z^-1)X(z)
    //    y[n] = k_3/k_4 * x[n] + k_3/k_4 * x[n-1] - k_5/k_4 * y[n-1]
    //
    //    let tau = 75 us
    //    let w_ca = tau^-1
    //    let fs = 44.1 kHz
    //    let k_1 = k_3/k_4 = w_ca / (2fs - w_ca)
    //    let k_2 = k_5/k_4 = ((2fs + w_ca)(fs - w_ca)) / ((2fs - w_ca)(fs + w_ca))
    //
    static const float k_1 = 0.17809439002671415F;
    static const float k_2 = 0.726501592564895F;

    *output_len = input_len;
    float* output_buffer = (float*)malloc(*output_len * sizeof(float));
    *output = output_buffer;

    float prev_output_sample = 0.0F;
    float prev_input_sample = 0.0F;
    for(size_t i = 0; i < *output_len; ++i) {
        output_buffer[i] = k_1 * input[i] + k_1 * prev_input_sample - k_2 * prev_output_sample;
        prev_input_sample = input[i];
        prev_output_sample = output_buffer[i];
    }
}

void polar_discriminant(const float complex* const input, size_t input_len, float** output, size_t* output_len)
{
    *output_len = input_len;
    float* output_buffer = (float*)malloc(*output_len * sizeof(float));
    *output = output_buffer;

    float complex prev_sample = 0.0F + 0.0F*I;
    for(size_t i = 0; i < input_len; ++i) {
        output_buffer[i] = cargf(input[i] * conjf(prev_sample)) / PI;
        prev_sample = input[i];
    }
}

void extract_mono_audio(const real_data_t* const demodulated_data, float** const output, size_t* output_len)
{
    if(demodulated_data->sample_rate_Hz != 250000) {
        fprintf(stderr, "Demodulated source data sample rate is expected to be 250kHz, not %uHz!", demodulated_data->sample_rate_Hz); //TODO: Handle arbitrary input sample rates
    }

    // Upsample the source data by a factor of three, this will facilitate subsequent downsampling by an integer value in order to arrive at an output sample rate of 44.1kHz
    const uint32_t interpolation_factor = 3;
    real_data_t upsampled_data;
    upsampled_data.sample_rate_Hz = demodulated_data->sample_rate_Hz * interpolation_factor;
    upsampled_data.num_samples = demodulated_data->num_samples * interpolation_factor;
    upsampled_data.samples = (float*)malloc(upsampled_data.num_samples * sizeof(float));
    memset(upsampled_data.samples, 0, upsampled_data.num_samples * sizeof(float));
    for(size_t i = 0; i < upsampled_data.num_samples; i += interpolation_factor) {
        upsampled_data.samples[i] = demodulated_data->samples[i/interpolation_factor];
    }

    // Decimate by 17 in order to arrive at the final output sample rate of 44.1kHz
    const uint32_t decimation_factor = 17;
    real_data_t mono_audio_data;
    mono_audio_data.sample_rate_Hz = upsampled_data.sample_rate_Hz / decimation_factor;

    fir_filter_r_t mono_audio_filter;
    init_filter_r(&mono_audio_filter, FIR_FILT_250kFS_15kPA_19kST, sizeof(FIR_FILT_250kFS_15kPA_19kST) / sizeof(*FIR_FILT_250kFS_15kPA_19kST));
    apply_filter_r(&mono_audio_filter, decimation_factor, upsampled_data.samples, upsampled_data.num_samples, &mono_audio_data.samples, &mono_audio_data.num_samples);
    destroy_filter_r(&mono_audio_filter);

    destroy_real_data(&upsampled_data);

    // Apply deemphasis filter in order to compensate for the pre-emphasis performed on the transmit side
    deemphasis_filtering(mono_audio_data.samples, mono_audio_data.num_samples, output, output_len);
    destroy_real_data(&mono_audio_data);
}

void extract_stereo_audio(const real_data_t* const demodulated_data, float** const output, size_t* output_len)
{
    if(demodulated_data->sample_rate_Hz != 250000) {
        fprintf(stderr, "Demodulated source data sample rate is expected to be 250kHz, not %uHz!", demodulated_data->sample_rate_Hz); //TODO: Handle arbitrary input sample rates
    }

    // Isolate the stereo pilot tone at 19kHz
    real_data_t pilot;
    pilot.sample_rate_Hz = demodulated_data->sample_rate_Hz;
    fir_filter_r_t pilot_filter;
    init_filter_r(&pilot_filter, FIR_FILT_250kFS_15kST_19kPA_23kST, sizeof(FIR_FILT_250kFS_15kST_19kPA_23kST) / sizeof(*FIR_FILT_250kFS_15kST_19kPA_23kST));
    memset(pilot_filter.delay_line, 0.0F, pilot_filter.num_taps - 1);
    pilot_filter.delay_line_num_samples = pilot_filter.num_taps - 1;
    apply_filter_r(&pilot_filter, 1, demodulated_data->samples, demodulated_data->num_samples, &pilot.samples, &pilot.num_samples);
    destroy_filter_r(&pilot_filter);

    // Square the pilot tone in order to synthesise the carrier signal at 38kHz
    for(size_t i = 0; i < pilot.num_samples; ++i) {
        pilot.samples[i] = pilot.samples[i] * pilot.samples[i];
    }

    // Isolate the synthesised carrier at 38kHz
    real_data_t carrier;
    carrier.sample_rate_Hz = pilot.sample_rate_Hz;
    fir_filter_r_t carrier_filter;
    init_filter_r(&carrier_filter, FIR_FILT_250kFS_34kST_38kPA_42kST, sizeof(FIR_FILT_250kFS_34kST_38kPA_42kST) / sizeof(*FIR_FILT_250kFS_34kST_38kPA_42kST));
    apply_filter_r(&carrier_filter, 1, pilot.samples, pilot.num_samples, &carrier.samples, &carrier.num_samples);
    destroy_filter_r(&carrier_filter);
    destroy_real_data(&pilot);

    // Isolate the stereo difference channel
    real_data_t delta_audio;
    delta_audio.sample_rate_Hz = carrier.sample_rate_Hz;
    fir_filter_r_t delta_filter;
    init_filter_r(&delta_filter, FIR_FILT_250KFS_19KST_38KPA_57KST, sizeof(FIR_FILT_250KFS_19KST_38KPA_57KST) / sizeof(*FIR_FILT_250KFS_19KST_38KPA_57KST));
    apply_filter_r(&delta_filter, 1, carrier.samples, carrier.num_samples, &delta_audio.samples, &delta_audio.num_samples);
    destroy_filter_r(&delta_filter);

    // Demodulate the DSB-SC stereo channel by mixing the stereo audio channel with the synthesised carrier
    for(size_t i = 0; i < delta_audio.num_samples; ++i) {
        delta_audio.samples[i] *= carrier.samples[i];
    }
    destroy_real_data(&carrier);

    // Isolate the sum channel (i.e. the mono channel)
    real_data_t sum_audio;
    sum_audio.sample_rate_Hz = demodulated_data->sample_rate_Hz;
    fir_filter_r_t mono_audio_filter;
    init_filter_r(&mono_audio_filter, FIR_FILT_250kFS_15kPA_19kST, sizeof(FIR_FILT_250kFS_15kPA_19kST) / sizeof(*FIR_FILT_250kFS_15kPA_19kST));
    apply_filter_r(&mono_audio_filter, 1, demodulated_data->samples, demodulated_data->num_samples, &sum_audio.samples, &sum_audio.num_samples);
    destroy_filter_r(&mono_audio_filter);

    // Extract the left channel by taking the sum of the delta channel data and the mono audio data
    real_data_t left_channel;
    left_channel.sample_rate_Hz = delta_audio.sample_rate_Hz;
    left_channel.num_samples = delta_audio.num_samples;
    left_channel.samples = (float*)malloc(left_channel.num_samples * sizeof(float));
    for(size_t i = 0; i < left_channel.num_samples; ++i) { // TODO: Ensure that the delta audio data and the mono audio data sample lengths are equivalent
        left_channel.samples[i] = sum_audio.samples[i] + delta_audio.samples[i];
    }
    normalise(left_channel.samples, left_channel.num_samples);

    // Extract the right channel by taking the difference of the mono audio data and the delta channel data
    real_data_t right_channel;
    right_channel.sample_rate_Hz = delta_audio.sample_rate_Hz;
    right_channel.num_samples = delta_audio.num_samples;
    right_channel.samples = (float*)malloc(left_channel.num_samples * sizeof(float));
    for(size_t i = 0; i < right_channel.num_samples; ++i) { // TODO: Ensure that the delta audio data and the mono audio data sample lengths are equivalent
        right_channel.samples[i] = sum_audio.samples[i] - delta_audio.samples[i];
    }
    normalise(right_channel.samples, right_channel.num_samples);

    destroy_real_data(&delta_audio);
    destroy_real_data(&sum_audio);

    // Downsample the left channel audio to 44.1kHz
    float* downsampled_left_audio = NULL;
    size_t num_downsampled_left_audio_samples = 0;
    extract_mono_audio(&left_channel, &downsampled_left_audio, &num_downsampled_left_audio_samples);
    destroy_real_data(&left_channel);

    // Downsample the right channel audio to 44.1kHz
    float* downsampled_right_audio = NULL;
    size_t num_downsampled_right_audio_samples = 0;
    extract_mono_audio(&right_channel, &downsampled_right_audio, &num_downsampled_right_audio_samples);
    destroy_real_data(&right_channel);

    // Interleave the left and right channel data in order to produce the stereo output
    const size_t stereo_output_len = num_downsampled_right_audio_samples * 2;
    float* stereo_output = (float*)malloc(stereo_output_len * sizeof(float));
    for(size_t i = 0; i < num_downsampled_left_audio_samples; ++i) {
        stereo_output[2 * i] = downsampled_left_audio[i];
        stereo_output[2 * i + 1] = downsampled_right_audio[i];
    }

    free(downsampled_left_audio);
    free(downsampled_right_audio);

    *output = stereo_output;
    *output_len = stereo_output_len;
}

void demodulate_fm(const iq_data_t* const iq_data)
{
    if(iq_data->sample_rate_Hz != 250000) {
        fprintf(stderr, "Source IQ data sample rate is expected to be 250kHz, not %uHz!", iq_data->sample_rate_Hz); //TODO: Handle arbitrary input sample rates
    }

    // Filter the source IQ data using a LPF with a 100kHz cut-off
    iq_data_t filtered_iq_data;
    filtered_iq_data.sample_rate_Hz = iq_data->sample_rate_Hz;

    fir_filter_c_t input_filter;
    init_filter_c(&input_filter, FIR_FILT_250kFS_100kPA_105kST, sizeof(FIR_FILT_250kFS_100kPA_105kST) / sizeof(*FIR_FILT_250kFS_100kPA_105kST));
    apply_filter_c(&input_filter, 1, iq_data->samples, iq_data->num_samples, &filtered_iq_data.samples, &filtered_iq_data.num_samples);
    destroy_filter_c(&input_filter);

    // Demodulate the FM signal
    real_data_t demodulated_data;
    demodulated_data.sample_rate_Hz = iq_data->sample_rate_Hz;

    polar_discriminant(filtered_iq_data.samples, filtered_iq_data.num_samples, &demodulated_data.samples, &demodulated_data.num_samples);
    destroy_iq_data(&filtered_iq_data);

    //do_plotting_r(demodulated_data.samples, demodulated_data.num_samples);

    // Extract the mono audio data
    float* mono_audio = NULL;
    size_t num_mono_samples = 0;
    extract_mono_audio(&demodulated_data, &mono_audio, &num_mono_samples);

    // float* stereo_audio = NULL;
    // size_t num_stereo_samples = 0;
    // extract_stereo_audio(&demodulated_data, &stereo_audio, &num_stereo_samples);

    destroy_real_data(&demodulated_data);

    int16_t* mono_audio_16 = (int16_t*)malloc(num_mono_samples * sizeof(int16_t));
    convert_data_ftos(mono_audio, mono_audio_16, num_mono_samples);
    write_data_to_file(mono_audio_16, num_mono_samples * sizeof(int16_t), "mono_audio.bin");
    free(mono_audio_16);
    free(mono_audio);

    // int16_t* stereo_audio_16 = (int16_t*)malloc(num_stereo_samples * sizeof(int16_t));
    // convert_data_ftos(stereo_audio, stereo_audio_16, num_stereo_samples);
    // write_data_to_file(stereo_audio_16, num_stereo_samples * sizeof(int16_t), "stereo_audio.bin");
    // free(stereo_audio_16);
    // free(stereo_audio);
}
